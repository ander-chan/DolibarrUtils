# Dillinger

[![N|Solid](https://cldup.com/dTxpPi9lDf.thumb.png)](https://nodesource.com/products/nsolid)

[![Build Status](https://travis-ci.org/joemccann/dillinger.svg?branch=master)](https://travis-ci.org/joemccann/dillinger)

# DolibarrUtils
Rest client android para dolibarr

**Instrucciones**
Agregar el repositorio desde jcenter

```
javabuildscript {
	repositories {
		google()
		jcenter()
            //...

```
```groovy
implementation 'com.github.medicamecanica:DolibarrUtils:master-SNAPSHOT'
implementation 'org.restlet.android:org.restlet:2.3.12'
implementation 'org.restlet.android:org.restlet.ext.jackson:2.3.12'
implementation 'org.restlet.android:org.restlet.ext.gson:2.3.12'
```

Permisos en el Manifest.xml
```xml
<uses-permission android:name="android.permission.INTERNET" />
<uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" /> 
```

  
  Si quieres integrar el Intent para autenticarse...
```xml
     <activity      android:name="co.medicamecanica.rest.login.LoginActivity"
       android:label="@string/app_name">
       </activity>
```
       
Requiere ```java setSupportActionBar(...) ```

Ahora, en el Activity, inicializar el cliente rest.
```java
    public class MainActivity extends AppCompatActivity{
	     RestClient.conf(this);
	     ...
```

 Típica respuesta Modulo REST API Dolibarr:
 
```json
    {
          "success": {
            "code": 200,
            "token": "a088c90b9ecd7bf0cbad5d7a7486877d2fc1c4de",
            "entity": "0",
            "message": "Welcome ander - This is your token (generated by a previous call). You can use it to make any REST API call, or enter it into the DOLAPIKEY field to use the Dolibarr API explorer."
          }
     }
```


   
```java
    //onCreate()
    RestClient.storeToken(null);//remueve cualquier toquen por defecto en los datos de configuración
            if (RestClient.getURL().isEmpty() //propiedad gestiona URL (ruta a /htdocs)
            || RestClient.getLogin().isEmpty() //propiedad login usuario
            || RestClient.getPassword().isEmpty()) {// propiedad password de usuario
                Intent intent = new Intent(getApplicationContext(), LoginActivity.class);// UI gestiona url,login,
                startActivity(intent);                                                   // password y entidad
            }
            ...
```        
  O como menú de configuración, Si se obtiene el token con éxito todas las 
  propiedades (url,login,password,token) estarán seteadas en la clase estatica REST.
  
```java
    public boolean onOptionsItemSelected(MenuItem item) {
            int id = item.getItemId();
            if (id == R.id.action_settings) {
                Intent intent = new Intent(getApplicationContext(), LoginActivity.class);
                startActivity(intent);
                return true;
            }
            ...
```        
Todas las peticiones (GET, POST ,PUT, etc.) a la API REST el token debe de estar en el header como :
```html
    DOLAPIKEY: a088c90b9ecd7bf0cbad5d7a7486877d2fc1c4de
```

Para interactuar con algun recurso, en este caso: 


**GET /users**		 List (Users)

Puedes ver la lista completa de recursos disponibles REST API en [htdocs/api/index.php/explorer#](explorer)

**Listado parametros recurso** [/users](users)
|Parameter|Description|Parameter Type|Data Type|
|--|--|--|--|
|sortfield|Sort field|query|string|
|sortorder|Sort order|query|string|
|limit|Limit for list|query|long|
|page|Page number|query|long|
|user_ids|User ids filter field. Example: '1' or '1,2,3'|query|string|
|sqlfilters|Other criteria to filter answers separated by a comma. Syntax example "(t.ref:like:'SO-%') and (t.date_creation:<:'20160101')"|query|string|





Ahora Creamos una classe donde implementamos: AsyncTask + Interface Resource (GET,POST,PUT, etc.) + Listener + Clase deserialisable (jackson o Gson)
```java
    public class UserClient {
            public static class FindUser extends AsyncTask<Void, Void, Integer> {
        
                private String search;
                private UserListener listener;
                public FindUser(String search,UserListener listener) {
                    this.search = search;
                    this.listener = listener;
                }
        
                @Override
                protected Integer doInBackground(Void... voids) {
                    try {             
        
                        ClientResource cr = RestClient.BuildClientResource(RestClient.getURL());
                        RestClient.addToken(cr,RestClient.getToken());
                        // segmento htdocs/api/index.php/users
                        cr.addSegment("users");
                        //parametros, ver lista para el recurso /users   
        
                        cr.addQueryParameter("sqlfilters","(login:like:'"+search.trim()+"')");//ejemplo query: (login:like:'ander') AND (...
                        
                        UserReosurce resource = cr.wrap(UserReosurce.class);
        
                        User[] users = resource.find();
                        Log.i("success", users.toString());
                        
                        listener.onFindUser(users);
                        return 200;
                    } catch (ResourceException e) {
                        e.printStackTrace();
                        if(e.getResponse()==null)
                            return -1;
                        Log.e("err", e.getResource().toString());
                        String resp = e.getResponse().getEntityAsText();
                        return e.getStatus().getCode();
                    }
                }
        
                @Override
                protected void onPostExecute(Integer integer) {
                    listener.onPostExecute(integer);
                    super.onPostExecute(integer);
                }
            }
            public static interface UserListener {
                public void onPostExecute(Integer code);
                 public    void onFindUser(User[] users);
            }
            public static interface UserReosurce {
                @Get
                public User[] find();
                public User get(Integer id);
            }
            @JsonIgnoreProperties(ignoreUnknown = true)
            @JsonInclude(JsonInclude.Include.NON_EMPTY)
            public static class User {
                public Integer id;
                @JsonProperty("login")
                public String login;
                @JsonProperty("photo")
                public String photo;
                public String firstname;
                public String lastname;
        
                public String fullName(){
                    String name=firstname+" "+lastname;
                    return name.trim();
                }
        
                @Override
                public String toString() {
                    return "User{" +
                            "id=" + id +
                            ", login='" + login + '\'' +
                            ", photo='" + photo + '\'' +
                            '}';
                }
            }
        }
```
En el Activity:

```java
new  UserClient.FindUser("ander", new UserClient.UserListener() {
       private UserClient.User[] users;

       @Override
       public void onPostExecute(Integer code) {
	    Log.d("onPostExecute",""+code);
	    if(code==200){
	      listusers(users);
	    }else if(code==405){
	      userNotFoundDialog(); 
	    }
       }
       @Override
       public void onFindUser(UserClient.User[] users) {
	   this.users=users;
	   Log.i("users>>", Arrays.toString(user));
       }
   }).execute();
```
